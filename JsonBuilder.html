<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JSON构建</title>
    <link rel="stylesheet" type="text/css" href="css/JsonBuilder.css">
    <link rel="stylesheet" type="text/css" href="static/gallery/element/element.css">
    <script type="text/javascript" src="static/gallery/vue/vue.min.js"></script>
    <script type="text/javascript" src="static/gallery/element/element.js"></script>
    <script type="text/javascript" src="config/fields.js"></script>
    <script type="text/javascript" src="static/common/field.js"></script>
    <!-- <script type="text/javascript" src="js/dom.js"></script>
    <script type="text/javascript" src="js/field.js"></script>
    <script type="text/javascript" src="js/filereader.js"></script>
    <script type="text/javascript" src="js/JsonBuilder.js"></script> -->
</head>

<body>
    <div id="app" class="json-container">
        <div class="json-input">
            <el-input type="textarea" placeholder="你可以在此输入通用查询JSON串,也可以在选择通用查询配置json文件" v-model="generalFieldsJSONString">
            </el-input>
        </div>
        <div class="json-runner">
            <el-button type="primary" @click="analyzeJSON">解析JSON</el-button>
            <p>
                <label>自定义列中的复选框勾选后,表示会默认展示的列,而自定义查询字段复选框勾选后表示需要显示的表单元素</label>
            </p>
        </div>
        <div class="fields-content">
            <el-tabs v-model="currentModule">
                <el-tab-pane label="自定义列" name="custom-field">
                    <el-table :data="customColumnFields" @selection-change="columnSelectionChangeHandle" height="400">
                        <el-table-column type="selection"></el-table-column>
                        <el-table-column type="index" label="序号"></el-table-column>
                        <el-table-column prop="label" label="字段名称"></el-table-column>
                        <el-table-column label="宽度(px)">
                            <el-input slot-scope="scope" v-model="scope.row.width"></el-input>
                        </el-table-column>
                        <el-table-column prop="propertyName" label="属性名称"></el-table-column>
                        <el-table-column prop="columnName" label="数据库列名"></el-table-column>
                        <el-table-column prop="columnType" label="数据库类型"></el-table-column>
                        <el-table-column label="过滤器">
                            <template slot-scope="scope">
                                <el-select v-model="scope.row.filter" v-if="scope.row.columnType.toLowerCase() === 'date'">
                                    <el-option v-for="(item, property) in timeFilters" :key="property" :label="item" :value="property">
                                    </el-option>
                                </el-select>
                                <label v-else>{{scope.row.filter}}</label>
                            </template>
                        </el-table-column>
                        <el-table-column prop="lookupCode" label="数据字典"></el-table-column>
                    </el-table>
                    <div class="json-builder">
                        <el-button type="primary" @click="builderCustomColumn">生成自定义列JSON</el-button>
                        <el-input type="textarea" v-model="customColumnJSONString">
                        </el-input>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="自定义查询字段" name="custom-search">
                    <el-table :data="fields" @selection-change="selectionChangeHandle" height="400">
                        <el-table-column type="selection"></el-table-column>
                        <el-table-column type="index" label="序号"></el-table-column>
                        <el-table-column prop="label" label="字段名称"></el-table-column>
                        <el-table-column prop="propertyName" label="属性名称"></el-table-column>
                        <el-table-column prop="columnName" label="数据库列名"></el-table-column>
                        <el-table-column prop="columnType" label="数据库类型"></el-table-column>
                        <el-table-column prop="lookupCode" label="数据字典"></el-table-column>
                    </el-table>

                    <div class="custom-search-field-config" v-if="customSearchFields.length">
                        <p class="tip">
                            注意：自定义查询字段详细配置.后续会持续优化,如遇到特殊情况可以重新编辑.
                        </p>
                        <el-table :data="customSearchFields">
                            <el-table-column type="index" label="序号"></el-table-column>
                            <el-table-column prop="label" label="字段名称"></el-table-column>
                            <el-table-column label="placeholder">
                                <el-input slot-scope="scope" v-model="scope.row.placeholder"></el-input>
                            </el-table-column>
                            <el-table-column label="表单类型">
                                <template slot-scope="scope">
                                    <label v-if="scope.row.columnType == 'date' || scope.row.columnType == 'enum'">{{scope.row.type}}</label>
                                    <el-select v-else v-model="scope.row.type">
                                        <el-option v-for="(item, property) in stringFileTypes" :key="property" :label="item" :value="property">
                                        </el-option>
                                    </el-select>
                                </template>
                            </el-table-column>
                            <el-table-column label="是否禁用">
                                <el-select slot-scope="scope" v-model="scope.row.disabled">
                                    <el-option v-for="(item, property) in disabled" :key="property" :label="item" :value="property">
                                    </el-option>
                                </el-select>
                            </el-table-column>
                            <el-table-column label="前括号">
                                <el-input slot-scope="scope" v-model="scope.row.frontBrackets"></el-input>
                            </el-table-column>
                            <el-table-column label="后括号">
                                <el-input slot-scope="scope" v-model="scope.row.postBrackets"></el-input>
                            </el-table-column>
                            <el-table-column label="条件关系">
                                <el-select slot-scope="scope" v-model="scope.row.conditionOperation">
                                    <el-option v-for="(item, property) in conditionOperations" :key="property" :label="item" :value="property">
                                    </el-option>
                                </el-select>
                            </el-table-column>
                            <el-table-column label="条件操作符">
                                <el-select slot-scope="scope" v-model="scope.row.operation">
                                    <el-option v-for="(operation, property) in scope.row.compareMap" :key="property" :label="operation" :value="property">
                                    </el-option>
                                </el-select>
                            </el-table-column>
                            <el-table-column label="日期类型">
                                <template slot-scope="scope">
                                    <el-select v-model="scope.row.dateType" v-if="scope.row.columnType.toLowerCase() === 'date'">
                                        <el-option v-for="(item, property) in dateTypes" :key="property" :label="item" :value="property">
                                        </el-option>
                                    </el-select>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>

                    <div class="json-builder">
                        <el-button type="primary" @click="builderCustomSearch">生成自定义查询JSON</el-button>
                        <el-input type="textarea" v-model="customSearchJSONString">
                        </el-input>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>
        <!-- <div class="json-builder">
            <el-button @click="configCustomColumn">配置自定义列</el-button>
            <el-button @click="configCustomSearch">配置自定义查询</el-button>
        </div> -->
        <!-- <div class="json-builder">
            <button class="builder-custom-column">生成自定义列JSON</button>
            <button class="builder-custom-search">生成自定义查询JSON</button>
            (
            <button class="json-copy">复制到剪切板</button>
            )
        </div>
        <div class="json-console">
            <pre>
            </pre>
        </div> -->
    </div>
</body>

<script type="text/x-template" id="field-template">
    <label>field</label>
</script>


<script type="text/javascript">
    /**
     * 支持的列类型
     * @description
     * 暂时支持四种： string, date, enum, number
     */
    const rcolumnType = /^(string|date|enum|number)$/

    /**
    * 不同类型的操作类型枚举
    */
    const CompareMap = {
        enum: ['contain', 'not_contain'],
        string: ['equal', 'not_equal', 'contain'],
        number: ['equal', 'not_equal', 'greaterthan', 'greaterthanorequal', 'lessthan', 'lessthanorequal'],
        date: ['greaterthan', 'greaterthanorequal', 'lessthan', 'lessthanorequal', 'between', 'not_between']
    }

    /**
     * 默认条件操作符
     */
    const DefaultCompare = {
        enum: 'contain',
        string: 'contain',
        number: 'equal',
        date: 'between'
    }

    /**
     * 条件操作符
     * @description 查看system_GenericQuery_Operation 数据字典管理
     */
    const GenericQueryOperation = {
        equal: '等于',
        not_equal: '不等于',
        greaterthan: '大于',
        greaterthanorequal: '大于等于',
        lessthan: '小于',
        lessthanorequal: '小于等于',
        contain: '包含于',
        not_contain: '不包含于',
        between: '范围于',
        not_between: '非范围于'
    }

    /**
     * 日期过滤器枚举
     */
    const DateFilterEnum = {
        date: 'date',
        minute: 'minute',
        time: 'time',
        second: 'second'
    }

    /**
     * 表单类型
     */
    const FormElementType = {
        text: 'text',
        textarea: 'textarea',
        area: 'area',
        autocomplete: 'autocomplete'
    }

    const UUID = (function () {
        const UUID_STRING =
            "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

        /**
         * 生成UUID
         * @param {Integer} len - UUID的长度
         * @param {Integer} radix - 进制
         * @see {Math.uuid.js}
         * @example
         * Framework.uuid() => F343F26D-2707-473E-840F-B11A96DDD4E6
         * Framework.uuid(8, 2) => 00011100
         * Framework.uuid(32, 16) => 0CECFF9C8AA4C227E2A289576DBAF208
         */
        const UUID = (len, radix) => {
            const chars = UUID_STRING.split("");

            len = /^[1-9]\d*$/.test(len) ? parseInt(len, 10) : null;
            radix = /^[1-9]\d*$/.test(radix) ? parseInt(radix, 10) : chars.length;

            let uuid = [];
            let i;

            if (len) {
                for (i = 0; i < len; i++) {
                    uuid[i] = chars[0 | (Math.random() * radix)];
                }
            } else {
                let r;

                uuid[8] = uuid[13] = uuid[18] = uuid[23] = "-";
                uuid[14] = "4";

                for (i = 0; i < 36; i++) {
                    if (!uuid[i]) {
                        r = 0 | (Math.random() * 16);
                        uuid[i] = chars[i == 19 ? (r & 0x3) | 0x8 : r];
                    }
                }
            }

            return uuid.join("");
        };

        return UUID;
    })()

    new Vue({
        el: '#app',
        data() {
            return {
                name: '1212',
                generalFieldsJSONString: JSON.stringify(DEFAULT_GENERAL_FIELDS, null, '\t'),
                customColumnFields: [],
                fields: [],
                customSearchFields: [],
                customColumnJSONString: '',
                customSearchJSONString: '',
                selection: [],
                currentModule: 'custom-field',
                timeFilters: {
                    date: 'date',
                    minute: 'minute',
                    time: 'time',
                    second: 'second'
                },
                conditionOperations: {
                    and: '且',
                    or: '或'
                },
                disabled: {
                    yes: '是',
                    no: '否'
                },
                stringFileTypes: {
                    text: 'text',
                    autocomplete: 'autocomplete',
                    area: 'area',
                    radio: 'radio',
                    checkbox: 'checkbox',
                    checkboxGroup: 'checkboxGroup'
                },
                dateTypes: {
                    year: 'year',
                    month: 'month',
                    date: 'date',
                    dates: 'dates',
                    week: 'week',
                    datetime: 'datetime',
                    datetimerange: 'datetimerange',
                    daterange: 'daterange'
                }
            }
        },
        computed: {
        },
        methods: {
            analyzeJSON() {
                let generalFields
                try {
                    generalFields = JSON.parse(this.generalFieldsJSONString)
                } catch (e) {
                    this.$alert('对不起,JSON解析失败,请检测', '温馨提示')
                }

                if (Array.isArray(generalFields)) {
                    let index = 0
                    let length = generalFields.length
                    let validate
                    let field
                    let base
                    for (index = 0; index < length; index++) {
                        field = generalFields[index]
                        validate = Field.validator(field)
                        if (validate.pass) {
                            base = {
                                propertyName: field.propertyName,
                                columnName: field.columnName,
                                columnType: field.columnType,
                                label: field.label,
                                lookupCode: field.lookupCode || '',
                                id: UUID()
                            }

                            let filter = field.lookupCode ? 'lookup' : field.columnType == 'date' ? 'time' : ''

                            this.customColumnFields.push(Object.assign({}, base, {
                                width: '100',
                                filter: filter
                            }))

                            this.fields.push(Object.assign({}, base))
                        } else {
                            this.$message.error(`第${index + 1}条配置出错:${validate.message}`)
                        }
                    }
                }
            },
            columnSelectionChangeHandle(selection) {
                this.selection = selection
            },
            selectionChangeHandle(selection) {
                let customSearchFields = []
                let compareMap

                selection.forEach(field => {
                    compareMap = {}
                    CompareMap[field.columnType].forEach(compare => {
                        compareMap[compare] = GenericQueryOperation[compare]
                    })

                    let type = field.columnType == 'enum' ? 'select' : field.columnType == 'date' ? 'datePicker' : 'text'

                    customSearchFields.push({
                        propertyName: field.propertyName,
                        columnName: field.columnName,
                        columnType: field.columnType,
                        label: field.label,
                        frontBrackets: '(',
                        postBrackets: ')',
                        conditionOperation: 'and',
                        operation: DefaultCompare[field.columnType],
                        type: type,
                        show: true,
                        compareMap: compareMap,
                        placeholder: `请填写${field.label}`,
                        disabled: 'no',
                        lookupCode: field.lookupCode,
                        dateType: 'date'
                    })
                })
                this.customSearchFields = customSearchFields
            },
            builderCustomColumn() {
                let fields = []
                let found
                let base
                this.customColumnFields.forEach(item => {
                    found = this.selection.find(row => row.id === item.id)

                    base = {
                        label: item.label,
                        key: item.propertyName,
                        show: !!found,
                        width: item.width + 'px'
                    }

                    if (item.lookupCode) {
                        base.filter = {
                            type: 'lookup',
                            args: [item.lookupCode]
                        }
                    } else if (item.columnType === 'date') {
                        base.filter = item.filter
                    }
                    fields.push(base)
                })
                this.customColumnJSONString = JSON.stringify(fields, null, '\t')
            },
            builderCustomSearch() {
                let fields = []
                let base
                this.customSearchFields.forEach(item => {
                    base = {
                        propertyName: item.propertyName,
                        columnName: item.columnName,
                        frontBrackets: item.frontBrackets,
                        postBrackets: item.postBrackets,
                        conditionOperation: item.conditionOperation,
                        operation: item.operation,
                        columnType: item.columnType,
                        label: item.label,
                        type: item.type,
                        show: true,
                        placeholder: item.placeholder,
                        disabled: item.disabled === 'no' ? false : true
                    }

                    switch (item.columnType) {
                        case 'date':
                            base.dateType = item.dateType
                            break
                        case 'enum':
                            base.lookupCode = item.lookupCode
                    }

                    fields.push(base)
                })
                this.customSearchJSONString = JSON.stringify(fields, null, '\t')
            }
        }
    });
</script>

</html>